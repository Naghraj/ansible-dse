---
- name: Install OpsCenter (yum)
  yum:
    name: item
    update_cache: yes
    state: installed
  with_items:
    - opscenter
  when: ansible_os_family == "RedHat"
  notify: reload systemd

- name: Install OpsCenter (apt)
  apt:
    name: item
    update_cache: yes
    state: installed
  with_items:
    - opscenter
  when: ansible_os_family == "Debian"

- meta: flush_handlers

- name: Update OpsCenter configuration
  template: src=opscenterd.conf.j2 dest=/etc/opscenter/opscenterd.conf
  notify: restart opscenter

- meta: flush_handlers

- name: Make sure OpsCenter is running
  service: name=opscenterd state=started enabled=yes
  tags:
    - services

- name: Upload the config for {{ cluster_name }}
  template: src=cluster_def.j2 dest=/tmp/cluster_def mode=0644
  tags:
    - cluster_create

- name: Slurp the config for {{ cluster_name }}
  slurp: src=/tmp/cluster_def
  register: cluster_def
  tags:
    - cluster_create

- name: Check if the config for {{ cluster_name }} already exists
  uri:
    url=http://{{ ansible_fqdn }}:8888/cluster-configs/{{ cluster_name }}
    method=GET
    status_code=200,201,202,404
    return_content=yes
  register: current_config
  tags:
    - cluster_create

- name: Register {{ cluster_name }} in OpsCenter
  uri:
    url=http://{{ ansible_fqdn }}:8888/cluster-configs
    method=POST
    body='{{ cluster_def.content | b64decode }}'
    body_format=json
    timeout={{ opscenter_config.add_cluster_timeout }}
    status_code=201
  when: current_config.status==404
  register: cluster
  tags:
    - cluster_create

- name: Update the config for {{ cluster_name }} in OpsCenter
  uri:
    url=http://{{ ansible_fqdn }}:8888/cluster-configs/{{ cluster_name }}
    method=PUT
    body='{{ cluster_def.content | b64decode }}'
    body_format=json
    timeout={{ opscenter_config.add_cluster_timeout }}
    status_code=204
  when: current_config.status==200
  register: cluster
  tags:
    - cluster_create

#- name: Login to OpsCenter and get session
#  uri:
#    url: {{ ansible_fqdn }}/opscenter/index.html
#    method: POST
#    user: {{ opscenter_user }}
#    password: {{ opscenter_pass }}
#    force_basic_auth: yes
#    status_code: 201
#  register: sessionid
